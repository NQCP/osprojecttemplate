# This pipeline is used to publish the package to the NQCP_Tier2 feed and push the documentation to another repository.
# It is triggered by the completion of the Build pipeline.
steps:
  - script: |
      git clone https://$(TARGET_REPO_TOKEN)@dev.azure.com/NQCP/NQCP/_git/NQCP-dp-git-webappdocs

      cd NQCP-dp-git-webappdocs
      
      mkdir -p webappdocs/_build/html/{{cookiecutter.package_name}}

      cp -r $BUILD_SOURCESDIRECTORY/docs/_build/html/* webappdocs/_build/html/{{cookiecutter.package_name}}

      cd webappdocs
      git config user.email "ci-bot@example.com"
      git config user.name  "ci-bot"
      git add .
      git commit -m "Update documentation"
      git push https://$(TARGET_REPO_TOKEN)@dev.azure.com/NQCP/NQCP/_git/NQCP-dp-git-webappdocs
    displayName: 'Push Documentation to Another Repo'
    env:
      TARGET_REPO_TOKEN: $(TARGET_REPO_TOKEN)
  - task: TwineAuthenticate@1
    inputs:
      artifactFeed: "NQCP/NQCP_Tier2"
  - task: CmdLine@2
  - inputs:
      script: |
        python -m twine upload -r NQCP_Tier2 --config-file $(PYPIRC_PATH) dist/*.whl --skip-existing
    displayName: "Upload package to PyPI feed"
    